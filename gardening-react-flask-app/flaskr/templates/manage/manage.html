{% extends 'base.html' %}



{% block header %}
  <h1>{% block title %}Device Management{% endblock %}</h1>
{% endblock %}


{% block content %}

{% for device in devices %}
<div class="card-header" id={{ "header_{}".format(device['id']) }}>
  <h2 class="mb-0">
    <button class="btn btn-link" data-toggle="collapse" href={{ "#manage_{}".format(device["id"]) }} role="button" aria-expanded="false" aria-controls={{ "#manage_{}".format(device["id"]) }}>
      {{ device["name"] }}
    </button>
  </h2>
</div>


<div class="collapse" id={{ "manage_{}".format(device["id"]) }} >
  <div class="card card-body">
    <form id={{ "form_{}".format(device["id"]) }}>

      <input type="hidden" class="form-control" name="id" value={{ device["id"] }}>


      <div class="form-group row">
        <label for="name" class="col-sm-2 col-form-label">Name</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="{{ "name_{}".format(device["name"]) }}" name="name" value="{{ device["name"] }}" placeholder="{{ device['name'] }}">
        </div>
      </div>

      <div class="form-group row">
        <label for="mac" class="col-sm-2 col-form-label">mac address</label>
        <div class="col-sm-10">
          <input type="text" readonly class="form-control" id={{ "mac_{}".format(device["mac"]) }} name="mac" value={{ device["mac"] }}>
        </div>
      </div>

      <div class="form-group row">
        <label for="checkin_time" class="col-sm-2 col-form-label">Last seen</label>
        <div class="col-sm-10">
          <input type="text" readonly class="form-control" id={{ "checkin_time_{}".format(device["id"]) }} name="checkin_time" value="{{ device["checkin_time"] }}">
        </div>
      </div>

      <div class="form-group row">
        <label for="INIT_INTERVAL" class="col-sm-2 col-form-label">INIT_INTERVAL</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id={{ "INIT_INTERVAL_{}".format(device["id"]) }} name="INIT_INTERVAL" value={{ device["INIT_INTERVAL"] }} placeholder="1" aria-describedby="INIT_INTERVAL_help">
          <small id="INIT_INTERVAL_help" class="form-text text-muted">Maximum amount of time (seconds) between INIT boots and connecting to wifi.</small>
        </div>
      </div>

      <div class="form-group row">
        <label for="SLEEP_DURATION" class="col-sm-2 col-form-label">SLEEP_DURATION</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id={{ "SLEEP_DURATION_{}".format(device["id"]) }} name="SLEEP_DURATION" value={{ device["SLEEP_DURATION"] }} placeholder="1" aria-describedby="SLEEP_DURAION_help">
          <small id="SLEEP_DURATION_help" class="form-text text-muted">How long to sleep (seconds) between wakeups (and sensor readings).</small>
        </div>
      </div>

      <div class="form-group row">
        <label for="SLEEP_DELAY" class="col-sm-2 col-form-label">SLEEP_DELAY</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id={{ "SLEEP_DELAY_{}".format(device["id"]) }} name="SLEEP_DELAY" value={{ device["SLEEP_DELAY"] }} placeholder="10" aria-describedby="SLEEP_DELAY_help">
          <small id="SLEEP_DELAY_help" class="form-text text-muted">How long to wait at the end of a cycle before going back to sleep.  Must be long enough to allow all actions (including http requests) to complete.</small>
        </div>
      </div>

      <div class="form-group row">
        <label for="LIGHT" class="col-sm-2 col-form-label">LIGHT</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id={{ "LIGHT_{}".format(device["id"]) }} name="LIGHT" value={{ device["LIGHT"] }} placeholder="10" aria-describedby="LIGHT_help">
          <small id="LIGHT_help" class="form-text text-muted">Turn on the LED while awake?  1 or 0.</small>
        </div>
      </div>



      <div class="form-group row">
        <label for="last_reading" class="col-sm-2 col-form-label">Last sensor reading</label>
        <div class="col-sm-5">
          <input type="text" readonly class="form-control" id={{ "reading_{}".format(device["id"]) }} value={{ device["value"] }}>
        </div>
        <div class="col-sm-5">
          <input type="text" readonly class="form-control" id={{ "reading_timestamp_{}".format(device["id"]) }} value="{{ device["timestamp"] }}">
        </div>
      </div>

      <div class="form-group row">
        <label for="calibration_max" class="col-sm-2 col-form-label">calibration_max</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id={{ "calibration_max_{}".format(device["id"]) }} name="calibration_max" value={{ device["calibration_max"] }} placeholder="10" aria-describedby="calibration_max_help">
          <small id="calibration_max_help" class="form-text text-muted">Sensor calibration "wet" reading</small>
        </div>
      </div>

      <div class="form-group row">
        <label for="calibration_min" class="col-sm-2 col-form-label">calibration_min</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id={{ "calibration_min_{}".format(device["id"]) }} name="calibration_min" value={{ device["calibration_min"] }} placeholder="10" aria-describedby="calibration_min_help">
          <small id="calibration_min_help" class="form-text text-muted">Sensor calibration "dry" reading</small>
        </div>
      </div>

      <div class="form-group row">
        <label for="trigger_min" class="col-sm-2 col-form-label">trigger_min</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id={{ "trigger_min_{}".format(device["id"]) }} name="trigger_min" value={{ device["trigger_min"] }} placeholder="10" aria-describedby="trigger_min_help">
          <small id="trigger_min_help" class="form-text text-muted">Plant sensor trigger value for "I need water!"</small>
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Submit</button>

    </form>
  </div>
</div>

{% endfor %}

<script>

  {% for device in devices %}
    document.getElementById("{{ "form_{}".format(device["id"]) }}").addEventListener('submit', (event) => {

        event.preventDefault(); // avoid to execute the actual submit of the form.

        $.ajax({
               type: "POST",
               url: "/api/submit_config",
               data: $("{{ "#form_{}".format(device["id"]) }}").serialize(),
               success: function(data)
               {
                   window.location = "/manage{{ "#manage_{}".format(device["id"]) }}"
               }
             });

    });
  {% endfor %}
</script>

{% endblock %}


